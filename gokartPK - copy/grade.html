<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0">
    <title>九号卡丁酷玩节</title>
    <link rel="stylesheet" href="./css/rem.css">
    <link rel="stylesheet" type="text/css" href="./css/loading.css">
    <link rel="stylesheet" type="text/css" href="./css/grade.css">
    <script src="./js/jquery-3.3.1.min.js"></script>
    <script src="./js/html2canvas.js"></script>
    <!--<script>-->
        <!--function mobile() {-->
            <!--var size = 100, //规定rem与px之间值的转换-->
                <!--maxWidth = 750; //设置基准宽度。-->
            <!--ratio = function() {-->
                <!--var r = document.documentElement.clientWidth / maxWidth;-->
                <!--return r >= 1 ? 1 : r <= 0.234 ? 0.234 : r;-->
            <!--};-->
            <!--set = function() {-->
                <!--document.documentElement.style.fontSize = ratio() * size + 'px';-->
            <!--}();-->
            <!--window.onresize = mobile;-->
        <!--}-->
        <!--mobile();-->
    <!--</script>-->
</head>
<body>
<div class="gokart-box" id="gradeBoxID">
    <div class="gokart-img1">
        <div class="gokart-img1-box">
            <div class="head-box">
                <img id="headImg"  src="" alt="">
            </div>
            <p class="head-name">陆家嘴藤原拓海</p>
            <div class="head-dec">
                <img src="./images/gokartPk5.png" alt="">
            </div>
            <div class="input-box">
                <div class="second" >
                    <input type="number" id="second" oninput="if(value.length>3)value=value.slice(0,3)">

                </div>
                <span class="time">秒</span>
                <div class="msec">
                    <input  type="number" id="msec"  oninput="if(value.length>2)value=value.slice(0,2)">

                </div>
                <span class="time">毫秒</span>
            </div>
        </div>
        <img src="./images/gokartPK3.jpg" alt="">
        <!--<img src="./images/1.jpg" alt="">-->
    </div>
    <div  class="gokart-img2">
        <div class="gokart-btn" id="gradeBtn">
            <img src="images/gokartPKBtn2.png" alt="">
        </div>
        <img src="./images/gokartPK4.jpg" alt="">
    </div>
</div>
<div id="popup-box">
    <p id="popup"></p>
</div>
<!--成功-->
<div class="gokart-box gokart-box-img" id="resultBoxID">
    <div class="gokart-img1">
        <img src="./images/gokartPK7.jpg" alt="">
    </div>
    <div class="gokart-img3">
        <div class="gokart-img1-box">
            <div class="main-box">
                <p><i class="main-left">我是<span>陆家嘴藤原拓海</span>，</i></p>
                <p><i>今天，我和韩寒相约东方明珠九号卡丁天台赛道，</i></p>
                <p><i class="main-right">开始了一场速度与激情的对决 ... ...</i></p>
            </div>
            <div class="grade-box">
                <div class="grade-one">
                    <div class="grade-one-my">
                        <p>我的成绩</p>
                        <!--<div class="grade-one-img" style="background: url('./images/2.jpg')">-->
                        <div class="grade-one-img">
                            <img  src="http://birthday.yangmb.com/photo/images/2.jpg" alt="">
                        </div>
                    </div>
                    <p class="grade-led" id="myGrade">00.00</p>

                </div>
                <div class="grade-two">
                    <div class="grade-two-my">
                        <!--<div class="grade-two-img" style="background: url('./images/gokartPKhan.jpg')">-->
                        <div class="grade-two-img">
                            <img  id="hh"  src="./images/gokartPKhan.jpg" alt="">
                        </div>
                        <p>
                            韩寒成绩
                        </p>
                    </div>
                    <p class="grade-led" id="hanGrade">00.00</p>

                </div>
                <img class="gradePKVS" src="./images/gokartPKVS.png" alt="">
            </div>
            <div class="grade-dec">
                <i>你是不是膨胀了？居然幻想比车神还快？居然幻想比车神还快？
                </i>
            </div>

        </div>
        <img src="./images/gokartPK9.jpg" alt="">
    </div>
    <div  class="gokart-img2">
        <div class="gokart-img2-pos">
            <div class="gokart-btn3">
                <img src="images/gokartPKBtn3.png" alt="">
            </div>
            <!--<div class="gokart-btn" id="saveImg">-->
            <!--<img src="images/gokartPKBtn4.png" alt="">-->
            <!--</div>-->

            <!--<div class="gokart-btn-fixed" data-html2canvas-ignore id="saveImg1">-->
                <!--<div>-->
                    <!--长按图片保存海报-->
                <!--</div>-->
                <!--&lt;!&ndash;<img src="images/gokartPKBtn4.png" alt="">&ndash;&gt;-->
            <!--</div>-->
        </div>
        <img src="./images/gokartPK8.jpg" alt="">
    </div>
</div>
<div class="gokart-btn-fixed" id="saveImg1">
    <div>
        长按图片保存海报
    </div>
    <!--<img src="images/gokartPKBtn4.png" alt="">-->
</div>
<!--加载条-->
<div class="load-box" id="loadID">
    <img src="./images/gokartPK6.jpg" alt="">
    <div class="progress-box">
        <div class="progress">
            <div class="progress-bar" style="width: 30%; " id="proLine">
                <span></span>
            </div>
        </div>
        <div class="load-title">
            <div>
                <b>Loading</b>
                <span class="load-span" id="loadText">0%</span>海报生成中 ... ...
            </div>
        </div>
    </div>
</div>
<script>
    // 将图片转为base64格式
    function img2base64(url, crossOrigin) {
        // 这里使用了 ES6 的Promise，及箭头函数
        return new Promise(resolve => {
            const img = new Image();

            img.onload = () => {
                const c = document.createElement('canvas');

                c.width = img.naturalWidth;
                c.height = img.naturalHeight;

                const cxt = c.getContext('2d');

                cxt.drawImage(img, 0, 0);

                // 得到图片的base64编码数据
                resolve(c.toDataURL('image/png'));
            };

            // 结合合适的CORS响应头，实现在画布中使用跨域<img>元素的图像
            crossOrigin && img.setAttribute('crossOrigin', crossOrigin);
            img.src = url;
        });
    }
    // 使用
    var imgUrl1 = 'http://birthday.yangmb.com/photo/images/2.jpg';
    img2base64(imgUrl1, 'Anonymous').then(function(res) {
        console.log(res);
    });

    //解决Android软键盘弹出覆盖h5页面输入框问题
    window.addEventListener('resize', () => {
        if (document.activeElement.tagName == 'INPUT') {
            //延迟出现是因为有些 Android 手机键盘出现的比较慢
            window.setTimeout(() => {
                document.activeElement.scrollIntoViewIfNeeded();
            }, 100);
        } });
    //安卓中，点击页面输入框，弹起的键盘把背景图顶起，再滑动页面有下方有空白。
    $('body').height($('body')[0].clientHeight);
    //在ios系统中输入框软键盘消失后，页面不回弹的问题
    var u = navigator.userAgent, app = navigator.appVersion
    var isIOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
    $(document).ready(function(){
        $("input").blur(function(){
            if (isIOS) {
                blurAdjust()
                // alert("1231321233")
            }
        });
    });
    // 解决苹果不回弹页面
    function blurAdjust(e){
        setTimeout(()=>{
            // alert("1231321233")
            if(document.activeElement.tagName == 'INPUT' || document.activeElement.tagName == 'TEXTAREA'){
                return
            }
            let result = 'pc';
            if(/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)) { //判断iPhone|iPad|iPod|iOS
                result = 'ios'
            }else if(/(Android)/i.test(navigator.userAgent)) {  //判断Android
                result = 'android'
            }

            if( result = 'ios' ){
                document.activeElement.scrollIntoViewIfNeeded(true);
            }
        },100)
    }

//    成功
    /**
     * 根据window.devicePixelRatio获取像素比
     */
    function DPR() {
        if (window.devicePixelRatio && window.devicePixelRatio > 1) {
            return window.devicePixelRatio;
        }
        return 1;
    }
    /**
     *  将传入值转为整数
     */
    function parseValue(value) {
        return parseInt(value, 10);
    };
    /**
     * 绘制canvas
     */
    async function drawCanvas (selector) {
        // 获取想要转换的 DOM 节点
        const dom = document.querySelector(selector);
        const box = window.getComputedStyle(dom);
        // DOM 节点计算后宽高
        const width = parseValue(box.width);
        const height = parseValue(box.height);
        // 获取像素比
        const scaleBy = DPR();
        // 创建自定义 canvas 元素
        var canvas = document.createElement('canvas');
        // 设定 canvas 元素属性宽高为 DOM 节点宽高 * 像素比
        canvas.width = width * scaleBy;
        canvas.height = height * scaleBy;
        // 设定 canvas css宽高为 DOM 节点宽高
        canvas.style.width = `${width}px`;
        canvas.style.height = `${height}px`;

        // 获取画笔
        const context = canvas.getContext('2d');

        // 将所有绘制内容放大像素比倍
        context.scale(scaleBy, scaleBy);

        let x = width;
        let y = height;
        return await html2canvas(dom, {canvas,}).then(function () {
            convertCanvasToImage(canvas, x ,y)
        })
    //     return await html2canvas(dom,{canvas,useCORS: true,allowTaint: true,taintTest: false}).then(function () {
    //         convertCanvasToImage(canvas, x ,y)
    // })
        // return await html2canvas(dom, {
        //     useCORS: true, // 【重要】开启跨域配置
        //     allowTaint: true,//允许跨域图片
        //     taintTest: false,//是否在渲染前测试图片
        //     onrendered: function(canvas) {
        //         convertCanvasToImage(canvas, x ,y)
        //     }
        // })

    }

    /**
     * 图片转base64格式
     */
    function convertCanvasToImage(canvas, x, y) {
        let image = new Image();
        let _container = document.getElementsByClassName('gokart-box-img')[0];
        let _body = document.getElementsByTagName('body')[0];
        image.width = x;
        image.height = y;
        image.src = canvas.toDataURL("image/png");
        _body.removeChild(_container);
        document.body.appendChild(image);
        return image;
    }
    $(function () {
        //    ajax请求附图片
        $('#headImg').attr('src','./images/2.jpg');
        // 判断是否都输入了信息
        $("#gradeBtn").click(function (e) {
            //秒，毫秒
            let second=$("#second").val();
            let msec=$("#msec").val();
            console.log(msec.length);

            //非负整数

            var secondReg = !!second.match(/^[0-9]+$/);
            var msecReg = !!msec.match(/^[0-9]+$/);
            // 秒
            if(second!==''&&secondReg == false){
                document.getElementById('popup-box').style.display='flex';
                document.getElementById('popup').innerText='请输入数字';
                setTimeout(function () {
                    document.getElementById('popup-box').style.display='none';
                    document.getElementById('popup').innerText='';
                },2000)
                return false;
            }
            if(msec!==''&&msecReg == false){
                document.getElementById('popup-box').style.display='flex';
                document.getElementById('popup').innerText='请输入数字';
                setTimeout(function () {
                    document.getElementById('popup-box').style.display='none';
                    document.getElementById('popup').innerText='';
                },2000)
                return false;
            }
            if(msec.length!==2){
                document.getElementById('popup-box').style.display='flex';
                document.getElementById('popup').innerText='毫秒为2位数字';
                setTimeout(function () {
                    document.getElementById('popup-box').style.display='none';
                    document.getElementById('popup').innerText='';
                },2000)
                return false;
            }
            if(second!==""&&msec!==""){
                $('#gradeBoxID').hide();//生成海报
                $('#popup-box').hide();//弹框
                $('#resultBoxID').hide();//成功页
                $('#saveImg1').hide();//保存图片按钮
                $('#loadID').show();//加载页

                //成功时执行的操作
                //加载条线性变换
                var t = 0;
                var che=30;
                function funs(){
                    t=t+3;
                    che=che+2;
                    $('#proLine').css('width',che+'%');
                    $('#loadText').html(t+'%');


                    if(t > 96) {
                        //在这里执行ajax
                        $('#proLine').css('width','100%');
                        $('#loadText').html('100%');
                        $('#myGrade').html('800.90');
                        $('#hanGrade').html('00.90');
                        //
                        $('#loadID').css('display','none')
                        $('#resultBoxID').css('display','block')
                        $('#saveImg1').css('display','block')
                        // drawCanvas('.gokart-box-img')
                        clearInterval(inter);
                    }
                }
                var inter = setInterval(function () {
                    funs()
                }, 100);

                setTimeout(function () {
                    // drawCanvas('.gokart-box-img')
                },6000)

            }else{
                document.getElementById('popup-box').style.display='flex';
                document.getElementById('popup').innerText='请输入成绩';
                setTimeout(function () {
                    document.getElementById('popup-box').style.display='none';
                    document.getElementById('popup').innerText='';
                },2000)
                return false;
            }
        })
    })
</script>
</body>
</html>
